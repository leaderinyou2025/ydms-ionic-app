<app-header
  [pageTitle]="TranslateKeys.PERSONAL_DIARY_TITLE"
  backgroundColor="linear-gradient(to bottom, #9333ea, #4c1d95)"
  [segment]="segment"
  [animeImage]="animeImage"
  (changeSegment)="segmentChanged($event)">
</app-header>

<ion-content [fullscreen]="true" class="font-comic-sans custom-page-bg-light">
  <!-- Diary entries -->
  <div class="px-4 py-2">
    <ng-container *ngIf="diaryEntries$ | async as entries">
      <div *ngIf="entries.length === 0" class="flex flex-col items-center justify-center py-12">
        <span class="text-5xl text-gray-400 mb-4">üìù</span>
        <p class="text-gray-500 dark:text-gray-400 text-center italic">{{ 'PERSONAL_DIARY.no_entries' | translate }}</p>
      </div>

      <div *ngFor="let entry of entries" class="bg-white dark:bg-gray-800 rounded-xl shadow-md mb-4 overflow-hidden relative">
        <!-- Card header with avatar and name -->
        <div class="flex items-center p-4 border-b border-gray-100 dark:border-gray-700">
          <ion-avatar class="w-10 h-10 mr-3">
            <img [src]="entry.user.avatar || 'assets/icons/svg/avatar.svg'" alt="Avatar" class="rounded-full">
          </ion-avatar>
          <div class="flex-1">
            <h3 class="text-base font-medium text-gray-800 dark:text-gray-200">{{ getDisplayName(entry) }}</h3>
            <p class="text-xs text-gray-500 dark:text-gray-400">{{ formatTimestamp(entry.timestamp) }}</p>
          </div>
          <div class="emotion-badge">
            <span class="text-xl">{{ getEmotionEmoji(entry.emotionType) }}</span>
          </div>
        </div>

        <!-- Card content -->
        <div class="p-4">
          <div class="relative">
            <p class="text-gray-700 dark:text-gray-300 text-sm leading-relaxed">{{ entry.content }}</p>
          </div>
        </div>

        <!-- Card actions -->
        <div class="flex items-center px-4 py-3 border-t border-gray-100 dark:border-gray-700">
          <!-- Reaction button -->
          <button
            class="flex items-center mr-4 py-1 px-3 rounded-full text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors duration-200 relative"
            (click)="toggleReactions(entry, $event)">
            <span class="mr-1 text-xl" [ngClass]="{'opacity-50': !getUserReaction(entry.id), 'opacity-100': getUserReaction(entry.id)}">{{ getReactionEmoji(getUserReaction(entry.id)) }}</span>

            <!-- Reaction summary (clickable) -->
            <div *ngIf="getTotalReactionsCount(entry.id) > 0"
                 class="ml-1 flex items-center bg-black bg-opacity-5 rounded-xl px-1.5 py-1 cursor-pointer transition-all duration-200 hover:bg-opacity-10"
                 (click)="showReactionStats(entry, $event)">
              <div class="flex -space-x-1 mr-1">
                <span *ngIf="getReactions(entry.id)?.love > 0" class="inline-flex items-center justify-center w-4 h-4 text-xs rounded-full bg-white dark:bg-gray-800 shadow">‚ù§Ô∏è</span>
                <span *ngIf="getReactions(entry.id)?.happy > 0" class="inline-flex items-center justify-center w-4 h-4 text-xs rounded-full bg-white dark:bg-gray-800 shadow">üòä</span>
                <span *ngIf="getReactions(entry.id)?.sad > 0" class="inline-flex items-center justify-center w-4 h-4 text-xs rounded-full bg-white dark:bg-gray-800 shadow">üò¢</span>
                <span *ngIf="getReactions(entry.id)?.angry > 0" class="inline-flex items-center justify-center w-4 h-4 text-xs rounded-full bg-white dark:bg-gray-800 shadow">üò°</span>
              </div>
              <span class="text-xs font-medium">{{ getTotalReactionsCount(entry.id) }}</span>
            </div>

            <!-- Reactions popup -->
            <div *ngIf="showReactions && reactionEntry?.id === entry.id"
                 class="absolute bottom-10 left-0 z-20 bg-white dark:bg-gray-800 rounded-full shadow-lg py-1 px-2 flex items-center reaction-popup">
              <button *ngFor="let reaction of reactions"
                      class="mx-1 transform transition-transform duration-200 hover:scale-125 bg-transparent border-0 cursor-pointer p-1 rounded-full relative"
                      [ngClass]="{'active-reaction hover:bg-opacity-10 bg-black bg-opacity-5 scale-110': getUserReaction(entry.id) === reaction.name}"
                      (click)="addReaction(entry.id, reaction.name, $event)">
                <span class="text-xl">{{ reaction.emoji }}</span>
              </button>
            </div>
          </button>

          <div class="flex ml-auto">
            <!-- Suggestion button (toggle) -->
            <button
              class="flex items-center mr-2 py-1 px-2 rounded-full transition-colors duration-200"
              [ngClass]="{
                'bg-yellow-100 text-yellow-700 dark:bg-yellow-900 dark:text-yellow-300': showSuggestions && selectedEntry?.id === entry.id,
                'text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700': !(showSuggestions && selectedEntry?.id === entry.id)
              }"
              (click)="showSuggestionsForEntry(entry, $event)">
              <span class="text-lg" [ngClass]="{
                'text-yellow-500': !(showSuggestions && selectedEntry?.id === entry.id),
                'text-yellow-700 dark:text-yellow-300': showSuggestions && selectedEntry?.id === entry.id
              }">üí°</span>
            </button>

            <!-- Withdraw button (only for own entries) -->
            <button
              *ngIf="isOwnEntry(entry)"
              class="flex items-center py-1 px-2 rounded-full text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors duration-200"
              (click)="withdrawEntry(entry.id)">
              <span class="text-lg text-red-500">‚Ü©Ô∏è</span>
            </button>
          </div>
        </div>

        <!-- Suggestions section (inside card) -->
        <div *ngIf="showSuggestions && selectedEntry?.id === entry.id"
             class="px-4 py-3 border-t border-gray-100 dark:border-gray-700 bg-yellow-50 dark:bg-gray-700 rounded-b-xl suggestions-section">
          <div class="flex justify-between items-center mb-2">
            <h4 class="text-sm font-semibold text-yellow-700 dark:text-yellow-300">{{ TranslateKeys.PERSONAL_DIARY_SUGGESTIONS | translate }}:</h4>
          </div>

          <!-- No suggestions message -->
          <div *ngIf="emotionSuggestions.length === 0" class="text-sm text-gray-600 dark:text-gray-300 italic">
            {{ 'PERSONAL_DIARY.no_suggestions' | translate }}
          </div>

          <!-- Suggestions list -->
          <ul *ngIf="emotionSuggestions.length > 0" class="pl-5 pr-2 mb-0">
            <li *ngFor="let suggestion of emotionSuggestions" class="text-sm text-gray-700 dark:text-gray-300 mb-1 list-disc">
              {{ suggestion }}
            </li>
          </ul>
        </div>
      </div>
    </ng-container>
  </div>

  <!-- Floating action button to add new entry -->
  <ion-fab vertical="bottom" horizontal="end" slot="fixed" class="mb-4 mr-4">
    <ion-fab-button color="primary" class="shadow-lg rounded-[30px]" (click)="openAddEntryModal()">
      <span class="text-xl">‚ûï</span>
    </ion-fab-button>
  </ion-fab>
</ion-content>
