<app-header
  [pageTitle]="TranslateKeys.TITLE_FAMILY_CONFLICT_IMPROVEMENT_CHALLENGE"
  defaultBackHref="/{{PageRoutes.HOME}}"
  backgroundColor="linear-gradient(to bottom, #9333ea, #4c1d95)"
  [animeImage]="animeImage"
>
</app-header>

<ion-content [fullscreen]="true" class="font-comic-sans">
  <!-- Pull to refresh -->
  <ion-refresher slot="fixed" (ionRefresh)="doRefresh($event)">
    <ion-refresher-content></ion-refresher-content>
  </ion-refresher>

  <!-- Loading spinner -->
  <ion-spinner *ngIf="isLoading" name="crescent"
               class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2"></ion-spinner>

  <!-- Empty state -->
  <div *ngIf="!isLoading && displayedItems.length === 0"
       class="flex flex-col items-center justify-center h-full p-4 text-center">
    <ion-icon name="trophy-outline" class="text-7xl text-gray-400 mb-4"></ion-icon>
    <h2 class="text-xl font-bold text-gray-600 mb-2">{{ TranslateKeys.TITLE_NO_CHALLENGES | translate }}</h2>
    <p class="text-gray-500 mb-6">{{ TranslateKeys.MESSAGE_NO_CHALLENGES | translate }}</p>
  </div>

  <!-- Challenge list -->
  <div *ngIf="!isLoading && displayedItems.length > 0" class="p-4 card-container">

    <!-- Challenge cards -->
    <ion-card *ngFor="let challenge of displayedItems"
              class="card-item rounded-xl shadow-lg overflow-hidden relative"
              (click)="viewChallengeDetail(challenge.id || 0)">
      <!-- Status chip positioned at top-right corner -->
      <ion-badge [color]="getStatusColor(challenge.status)" class="status-chip px-2 py-1 rounded-full absolute top-[10px] right-1 z-10">
        {{ getStatusText(challenge.status) }}
      </ion-badge>
      <ion-card-header class="bg-blue-50">
        <ion-card-subtitle class="flex justify-start items-center">
          <span class="text-gray-500">{{ challenge.date | date:'mediumDate' }}</span>
        </ion-card-subtitle>
        <ion-card-title class="text-lg font-semibold pt-3">{{ challenge.title }}</ion-card-title>
      </ion-card-header>

      <ion-card-content class="p-4">
        <!-- Progress bar -->
        <div class="mb-3">
          <div class="flex justify-between text-sm mb-1">
            <span class="text-gray-600">{{ TranslateKeys.LABEL_PROGRESS | translate }}</span>
            <span class="font-bold">{{ challenge.progress }}%</span>
          </div>
          <ion-progress-bar [value]="challenge.progress / 100"
                           [color]="challenge.progress === 100 ? 'success' : 'primary'"
                           class="h-2 rounded-full"></ion-progress-bar>
        </div>

        <!-- Badge earned (if completed) -->
        <div *ngIf="challenge.badgeEarned" class="flex items-center mt-3 p-2 bg-yellow-50 rounded-lg">
          <ion-icon name="ribbon" class="text-2xl text-yellow-500 mr-2"></ion-icon>
          <div>
            <div class="text-sm font-bold text-gray-700">{{ TranslateKeys.LABEL_BADGE_EARNED | translate }}</div>
            <div class="text-yellow-700">{{ challenge.badgeEarned }}</div>
          </div>
        </div>
      </ion-card-content>
    </ion-card>

    <!-- Infinite scroll -->
    <ion-infinite-scroll threshold="100px" (ionInfinite)="loadMoreItems($event)" [disabled]="!hasMoreItems">
      <ion-infinite-scroll-content loadingSpinner="bubbles"
                                  loadingText="{{ TranslateKeys.MESSAGE_LOADING_MORE | translate }}">
      </ion-infinite-scroll-content>
    </ion-infinite-scroll>
  </div>

  <!-- Floating action button to add new entry -->
  <ion-fab vertical="bottom" horizontal="end" slot="fixed" class="mb-4 mr-4">
    <ion-fab-button color="primary" class="shadow-lg rounded-[30px]" (click)="createNewChallenge()">
      <span class="text-xl">âž•</span>
    </ion-fab-button>
  </ion-fab>
</ion-content>
